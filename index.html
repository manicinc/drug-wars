<!-- TODO: MOve this to www -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta description="An enhanced remake of the classic Drug Wars game with deeper health and item mechanics.">
    <meta name="keywords" content="Drug Wars, remake, game, classic, enhanced, HTML5, JavaScript">
    <meta name="author" content="Enhanced by Claude">
    <title>Drug Wars Enhanced</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html {
            height: 100%;
            touch-action: pan-x pan-y;
        }
        
        body {
            height: 100%;
            font-family: 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
        }
        
        button, input, select, textarea, a {
            touch-action: manipulation;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        input, select, textarea {
            font-size: 16px !important;
        }
        
        *:focus {
            outline: none;
        }
        
        button:focus, 
        input:focus,
        .drug-item:focus,
        .item-button:focus,
        .modal-content:focus {
            outline: 2px solid #ffff00;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(255, 255, 0, 0.3);
        }
        
        .keyboard-nav button:focus {
            transform: scale(1.05);
        }
        
        .keyboard-indicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 0, 0.9);
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
            z-index: 100;
        }
        
        body.keyboard-nav .keyboard-indicator {
            display: block;
        }
        
        .main-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 60px 10px 90px 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        .game-container {
            width: 100%;
            max-width: 800px;
            background-color: #1a1a1a;
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 15px;
            font-size: clamp(1.5rem, 5vw, 2rem);
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #0f0f0f;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
        }
        
        .stat-item span:first-child {
            font-size: 0.8em;
            opacity: 0.7;
        }
        
        .stat-item span:last-child {
            font-weight: bold;
            color: #ffff00;
        }
        
        /* Health warning colors */
        .health-critical { color: #ff0000 !important; }
        .health-low { color: #ff8800 !important; }
        .health-good { color: #ffff00 !important; }
        .health-excellent { color: #00ff00 !important; }
        
        .location {
            text-align: center;
            font-size: clamp(1rem, 3vw, 1.2rem);
            margin-bottom: 15px;
            padding: 10px;
            background-color: #0f0f0f;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        .market {
            margin-bottom: 15px;
        }
        
        .market h3, .inventory h3, .items h3 {
            margin-bottom: 10px;
            text-align: center;
            font-size: clamp(1rem, 3vw, 1.1rem);
        }
        
        .drug-list {
            display: grid;
            gap: 8px;
        }
        
        .drug-item {
            display: grid;
            grid-template-columns: minmax(80px, 2fr) minmax(60px, 1fr) minmax(50px, 1fr) auto;
            align-items: center;
            padding: 8px;
            background-color: #0f0f0f;
            border: 1px solid #00ff00;
            border-radius: 5px;
            transition: all 0.3s;
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
            gap: 5px;
            cursor: pointer;
            position: relative;
            tabindex: 0;
        }
        
        .drug-item:hover,
        .drug-item.keyboard-focus {
            background-color: #1f1f1f;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            transform: translateY(-2px);
        }
        
        .drug-item:active {
            transform: scale(0.98);
        }
        
        .drug-item.selected {
            background-color: #2f2f2f;
            border-color: #ffff00;
        }
        
        .drug-name {
            font-weight: bold;
            word-break: break-word;
        }
        
        .drug-price {
            text-align: right;
            color: #ffff00;
        }
        
        .drug-owned {
            text-align: right;
            opacity: 0.8;
        }
        
        .drug-buttons {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
        }
        
        /* Items section */
        .items {
            margin-bottom: 15px;
            padding: 12px;
            background-color: #0f0f0f;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
        }
        
        .item-button {
            background-color: #1a1a1a;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            border-radius: 3px;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 2px;
            position: relative;
        }
        
        .item-button:hover {
            background-color: #2a2a2a;
            transform: translateY(-1px);
        }
        
        .item-button:active {
            transform: scale(0.95);
        }
        
        .item-button:disabled {
            background-color: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .item-name {
            font-weight: bold;
            font-size: 13px;
        }
        
        .item-price {
            color: #ffff00;
            font-size: 12px;
        }
        
        .item-effect {
            color: #888;
            font-size: 11px;
        }
        
        .item-owned {
            position: absolute;
            top: 2px;
            right: 4px;
            background: #00ff00;
            color: #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .item-broken {
            opacity: 0.5;
            border-color: #ff0000;
        }
        
        .item-broken .item-name::after {
            content: " (BROKEN)";
            color: #ff0000;
            font-size: 10px;
        }
        
        button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            border-radius: 3px;
            transition: all 0.3s;
            font-size: 16px !important;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
            position: relative;
        }
        
        button:hover {
            background-color: #00cc00;
            transform: translateY(-1px);
        }
        
        button:active {
            background-color: #00cc00;
            transform: scale(0.95);
        }
        
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: scale(1);
            opacity: 0.5;
        }
        
        button:disabled:hover {
            background-color: #666;
            transform: scale(1);
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .actions button {
            padding: 10px 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .message {
            margin-top: 15px;
            padding: 12px;
            background-color: #0f0f0f;
            border: 1px solid #00ff00;
            border-radius: 5px;
            text-align: center;
            min-height: 50px;
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            touch-action: none;
        }
        
        .modal-content {
            background-color: #1a1a1a;
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            tabindex: -1;
        }
        
        .modal h3 {
            margin-bottom: 15px;
            text-align: center;
            font-size: clamp(1.1rem, 3vw, 1.3rem);
            color: #00ff00;
        }
        
        .modal input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background-color: #0f0f0f;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: inherit;
            border-radius: 3px;
            font-size: 16px !important;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 16px !important;
        }
        
        .inventory {
            margin-bottom: 15px;
            padding: 12px;
            background-color: #0f0f0f;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
        }
        
        .info-button {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #00ff00;
            color: #000;
            border: 2px solid #fff;
            font-size: 24px !important;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .info-button:hover {
            transform: scale(1.1);
            background-color: #00cc00;
        }
        
        .info-button:active {
            transform: scale(0.95);
            background-color: #00cc00;
        }
        
        .info-content {
            padding: 0;
            line-height: 1.6;
        }
        
        .info-content h4 {
            color: #00ff00;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: clamp(1rem, 3vw, 1.1rem);
        }
        
        .info-content p, .info-content ul {
            margin-bottom: 10px;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
        }
        
        .info-content ul {
            padding-left: 20px;
        }
        
        .info-content li {
            margin-bottom: 5px;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #00ff00;
            color: #000;
            padding: 8px;
            text-decoration: none;
            font-weight: bold;
            z-index: 200;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .flash {
            animation: flash 0.5s ease-in-out;
        }
        
        @keyframes healthPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
        }
        
        .health-warning {
            animation: healthPulse 2s infinite;
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            .game-container {
                padding: 10px;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .main-container {
                padding: 60px 0 90px 0;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .drug-item {
                grid-template-columns: 2fr 1fr;
                grid-template-rows: auto auto;
            }
            
            .drug-name {
                grid-column: 1;
            }
            
            .drug-price {
                grid-column: 2;
                text-align: right;
            }
            
            .drug-owned {
                grid-column: 1;
                text-align: left;
                font-size: 0.8em;
            }
            
            .drug-buttons {
                grid-column: 2;
            }
            
            .drug-buttons button {
                font-size: 16px !important;
                padding: 8px;
            }
            
            .actions {
                grid-template-columns: 1fr;
            }
            
            .items-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 768px) {
            .stats {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .actions {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .items-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .main-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .main-container::-webkit-scrollbar-track {
            background: #0f0f0f;
        }
        
        .main-container::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 4px;
        }
        
        .main-container::-webkit-scrollbar-thumb:hover {
            background: #00cc00;
        }
        
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <button class="info-button" onclick="showInfo()" aria-label="Game Info">?</button>
    
    <div class="keyboard-indicator">Keyboard Mode Active</div>
    
    <div class="main-container" id="main-content">
        <div class="game-container">
            <h1>üíä DRUG WARS ENHANCED üíä</h1>
            
            <div class="stats">
                <div class="stat-item">
                    <span>Cash</span>
                    <span id="cash">$2,000</span>
                </div>
                <div class="stat-item">
                    <span>Debt</span>
                    <span id="debt">$5,500</span>
                </div>
                <div class="stat-item">
                    <span>Bank</span>
                    <span id="bank">$0</span>
                </div>
                <div class="stat-item">
                    <span>Day</span>
                    <span id="day">1/30</span>
                </div>
                <div class="stat-item">
                    <span>Space</span>
                    <span id="space">100/100</span>
                </div>
                <div class="stat-item">
                    <span>Health</span>
                    <span id="health">100%</span>
                </div>
            </div>
            
            <div class="location">
                üìç <span id="current-location">Bronx</span>
            </div>
            
            <div class="inventory" id="inventory">
                <h3>Your Stash</h3>
                <div id="inventory-list"></div>
            </div>
            
            <div class="items">
                <h3>üõí Black Market Items</h3>
                <div class="items-grid" id="items-grid"></div>
            </div>
            
            <div class="market">
                <h3>üí∞ Street Prices</h3>
                <div class="drug-list" id="drug-list" role="list"></div>
            </div>
            
            <div class="actions">
                <button onclick="showTravelMenu()">‚úàÔ∏è Travel</button>
                <button onclick="visitLoanShark()">üí∞ Loan Shark</button>
                <button onclick="visitBank()">üè¶ Bank</button>
                <button onclick="visitHospital()">üè• Hospital</button>
            </div>
            
            <div class="message" id="message" role="status" aria-live="polite">
                Welcome to Drug Wars Enhanced! Your health now affects everything. Buy meds and gear to survive!
            </div>
        </div>
    </div>
    
    <div class="modal" id="modal" role="dialog" aria-modal="true">
        <div class="modal-content" tabindex="-1">
            <h3 id="modal-title">Transaction</h3>
            <p id="modal-text"></p>
            <input type="number" id="modal-input" min="0" inputmode="numeric" aria-label="Amount">
            <div class="modal-buttons">
                <button id="modal-confirm">Confirm</button>
                <button onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="travel-modal" role="dialog" aria-modal="true">
        <div class="modal-content" tabindex="-1">
            <h3>Choose Destination</h3>
            <div id="travel-options" role="list"></div>
            <div class="modal-buttons">
                <button onclick="closeTravelModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="info-modal" role="dialog" aria-modal="true">
        <div class="modal-content" tabindex="-1">
            <h3>üìñ Drug Wars Enhanced - How to Play</h3>
            <div class="info-content">
                <h4>üéÆ About</h4>
                <p>An enhanced version of the classic Drug Wars with deeper health and item mechanics. Your health now affects every aspect of the game!</p>
                
                <h4>üíä Health System</h4>
                <ul>
                    <li><strong>Health Decay:</strong> You lose 2-5 health daily from stress and lifestyle</li>
                    <li><strong>Performance Impact:</strong> Low health = worse deals, more danger, higher prices</li>
                    <li><strong>Critical Health:</strong> Below 30% health increases risk of all bad events</li>
                    <li><strong>Medications:</strong> Buy painkillers (+10 health) and first aid kits (+20 health)</li>
                    <li><strong>Hospital:</strong> Now more expensive - $200 per health point!</li>
                </ul>
                
                <h4>üõ°Ô∏è Enhanced Items</h4>
                <ul>
                    <li><strong>Body Armor ($800):</strong> Reduces damage by 50%, can break after 3-5 hits</li>
                    <li><strong>Fake ID ($300):</strong> 50% less likely to be caught by police</li>
                    <li><strong>Burner Phone ($150):</strong> Warns of police raids 25% of the time</li>
                    <li><strong>Painkillers ($25):</strong> Consumable, +10 health, stackable</li>
                    <li><strong>First Aid Kit ($50):</strong> Consumable, +20 health, stackable</li>
                    <li><strong>Trench Coat ($200):</strong> +50 carrying space, can get damaged</li>
                    <li><strong>Duffel Bag ($400):</strong> +75 carrying space, can get damaged</li>
                    <li><strong>Gun ($500):</strong> Protection from danger, can misfire over time</li>
                </ul>
                
                <h4>‚ö° New Mechanics</h4>
                <ul>
                    <li><strong>Item Durability:</strong> Some items break and need replacement</li>
                    <li><strong>Health Penalties:</strong> Poor health = worse prices, more muggings</li>
                    <li><strong>Strategic Depth:</strong> Plan your purchases carefully!</li>
                    <li><strong>Risk Management:</strong> Items are investments in your survival</li>
                </ul>
                
                <h4>üèÜ Survival Tips</h4>
                <ul>
                    <li>Always carry painkillers - they're cheap insurance</li>
                    <li>Body armor is expensive but saves your life</li>
                    <li>Watch your health constantly - it affects everything</li>
                    <li>Fake ID and burner phone reduce police encounters</li>
                    <li>Items can break - keep spares of essentials</li>
                </ul>
                
                <p style="text-align: center; margin-top: 20px;"><strong>Survive the streets with strategy!</strong></p>
            </div>
            <div class="modal-buttons">
                <button onclick="closeInfoModal()">Let's Survive!</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced game state with new mechanics
        let gameState = {
            cash: 2000,
            debt: 5500,
            bank: 0,
            day: 1,
            maxDays: 30,
            health: 100,
            location: 'Bronx',
            maxSpace: 100,
            inventory: {},
            prices: {},
            items: {
                gun: { owned: false, broken: false, durability: 100 },
                coat: { owned: false, broken: false, durability: 100 },
                duffelBag: { owned: false, broken: false, durability: 100 },
                armor: { owned: false, broken: false, durability: 100 },
                fakeId: { owned: false, broken: false, durability: 100 },
                phone: { owned: false, broken: false, durability: 100 },
                painkillers: { owned: 0 },
                firstAid: { owned: 0 }
            }
        };
        
        // UI state
        let selectedDrugIndex = 0;
        let keyboardMode = false;
        let lastInteractionWasKeyboard = false;
        
        // Game configuration
        const locations = ['Bronx', 'Ghetto', 'Central Park', 'Manhattan', 'Coney Island', 'Brooklyn'];
        
        const drugs = [
            { name: 'Cocaine', minPrice: 15000, maxPrice: 30000 },
            { name: 'Heroin', minPrice: 5000, maxPrice: 14000 },
            { name: 'Acid', minPrice: 1000, maxPrice: 4500 },
            { name: 'Weed', minPrice: 300, maxPrice: 900 },
            { name: 'Speed', minPrice: 70, maxPrice: 250 },
            { name: 'Ludes', minPrice: 10, maxPrice: 60 }
        ];
        
        // Enhanced items with strategic value
        const blackMarketItems = [
            {
                id: 'painkillers',
                name: 'Painkillers',
                price: 25,
                effect: '+10 Health',
                description: 'Quick health boost',
                consumable: true,
                maxStack: 10
            },
            {
                id: 'firstAid',
                name: 'First Aid Kit',
                price: 50,
                effect: '+20 Health',
                description: 'Major health restoration',
                consumable: true,
                maxStack: 5
            },
            {
                id: 'armor',
                name: 'Body Armor',
                price: 800,
                effect: '50% Damage Reduction',
                description: 'Reduces damage from events',
                consumable: false,
                durability: true
            },
            {
                id: 'fakeId',
                name: 'Fake ID',
                price: 300,
                effect: '-50% Police Risk',
                description: 'Avoid police encounters',
                consumable: false,
                durability: true
            },
            {
                id: 'phone',
                name: 'Burner Phone',
                price: 150,
                effect: 'Police Warnings',
                description: 'Warns of raids 25% of time',
                consumable: false,
                durability: true
            },
            {
                id: 'coat',
                name: 'Trench Coat',
                price: 200,
                effect: '+50 Space',
                description: 'Increases carrying capacity',
                consumable: false,
                durability: true
            },
            {
                id: 'duffelBag',
                name: 'Duffel Bag',
                price: 400,
                effect: '+75 Space',
                description: 'Large carrying capacity boost',
                consumable: false,
                durability: true
            },
            {
                id: 'gun',
                name: 'Gun',
                price: 500,
                effect: 'Combat Protection',
                description: 'Protects from muggers',
                consumable: false,
                durability: true
            }
        ];
        
        // Setup modal click-outside-to-close functionality
        function setupModalClickOutside() {
            // Get all modals
            const modals = document.querySelectorAll('.modal');
            
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    // Only close if clicking the modal backdrop, not the content
                    if (e.target === modal) {
                        // Close the appropriate modal
                        if (modal.id === 'modal') {
                            closeModal();
                        } else if (modal.id === 'travel-modal') {
                            closeTravelModal();
                        } else if (modal.id === 'info-modal') {
                            closeInfoModal();
                        }
                    }
                });
            });
        }
        
        // Initialize game
        function initGame() {
            updatePrices();
            updateDisplay();
            setupKeyboardNavigation();
            setupModalClickOutside();
            
            showMessage("Welcome to Drug Wars Enhanced! Press ? for help. Good luck!");
        }
        
        // Setup keyboard navigation (simplified for space)
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', function(e) {
                lastInteractionWasKeyboard = true;
                if (!keyboardMode) {
                    keyboardMode = true;
                    document.body.classList.add('keyboard-nav');
                }
            });
            
            document.addEventListener('mousedown', function() {
                lastInteractionWasKeyboard = false;
                if (keyboardMode) {
                    keyboardMode = false;
                    document.body.classList.remove('keyboard-nav');
                }
            });
            
            // Global keyboard shortcuts remain the same...
        }
        
        // Health effects on gameplay
        function getHealthMultiplier() {
            if (gameState.health >= 80) return 1.0;      // Excellent
            if (gameState.health >= 60) return 0.9;      // Good
            if (gameState.health >= 40) return 0.75;     // Okay
            if (gameState.health >= 20) return 0.6;      // Poor
            return 0.4;                                    // Critical
        }
        
        function getHealthRiskMultiplier() {
            if (gameState.health >= 80) return 1.0;      // Normal risk
            if (gameState.health >= 60) return 1.2;      // Slightly higher risk
            if (gameState.health >= 40) return 1.5;      // Higher risk
            if (gameState.health >= 20) return 2.0;      // Much higher risk
            return 3.0;                                    // Extremely high risk
        }
        
        // Daily health decay
        function applyDailyHealthDecay() {
            const decay = Math.floor(Math.random() * 4) + 2; // 2-5 health loss
            gameState.health = Math.max(0, gameState.health - decay);
            
            if (gameState.health <= 30 && gameState.health > 0) {
                showMessage(`‚ö†Ô∏è Your health is critically low (${gameState.health}%)! You feel terrible and everything is harder.`);
            }
        }
        
        // Item durability system
        function damageItem(itemId, damage = 20) {
            if (gameState.items[itemId] && gameState.items[itemId].owned && !gameState.items[itemId].broken) {
                gameState.items[itemId].durability -= damage;
                if (gameState.items[itemId].durability <= 0) {
                    gameState.items[itemId].broken = true;
                    gameState.items[itemId].durability = 0;
                    const item = blackMarketItems.find(i => i.id === itemId);
                    showMessage(`üíî Your ${item.name} broke! You need to buy a replacement.`);
                    
                    // Special effects when items break
                    if (itemId === 'coat') {
                        gameState.maxSpace = getMaxSpace();
                        showMessage("Lost 50 carrying space from broken coat!");
                    } else if (itemId === 'duffelBag') {
                        gameState.maxSpace = getMaxSpace();
                        showMessage("Lost 75 carrying space from broken duffel bag!");
                    }
                }
            }
        }
        
        // Update drug prices with health effects
        function updatePrices() {
            gameState.prices = {};
            const healthMultiplier = getHealthMultiplier();
            
            drugs.forEach(drug => {
                let price = Math.floor(Math.random() * (drug.maxPrice - drug.minPrice + 1)) + drug.minPrice;
                
                // Health affects prices - sick dealers get worse deals
                if (healthMultiplier < 1.0) {
                    price = Math.floor(price / healthMultiplier);
                }
                
                // Random price events
                if (Math.random() < 0.1) {
                    if (Math.random() < 0.5) {
                        price = Math.floor(price * 0.2);
                        setTimeout(() => showMessage(`Cops made a big ${drug.name} bust! Prices crashed!`), 100);
                    } else {
                        price = Math.floor(price * 3);
                        setTimeout(() => showMessage(`${drug.name} shortage! Prices skyrocketed!`), 100);
                    }
                }
                
                gameState.prices[drug.name] = price;
            });
        }
        
        // Calculate used space with coat effect
        function getUsedSpace() {
            return Object.values(gameState.inventory).reduce((sum, qty) => sum + qty, 0);
        }
        
        function getMaxSpace() {
            let maxSpace = 100;
            if (gameState.items.coat.owned && !gameState.items.coat.broken) {
                maxSpace += 50;
            }
            if (gameState.items.duffelBag.owned && !gameState.items.duffelBag.broken) {
                maxSpace += 75;
            }
            return maxSpace;
        }
        
        // Update display with health color coding
        function updateDisplay() {
            document.getElementById('cash').textContent = `$${gameState.cash.toLocaleString()}`;
            document.getElementById('debt').textContent = `$${gameState.debt.toLocaleString()}`;
            document.getElementById('bank').textContent = `$${gameState.bank.toLocaleString()}`;
            document.getElementById('day').textContent = `${gameState.day}/${gameState.maxDays}`;
            document.getElementById('space').textContent = `${getUsedSpace()}/${getMaxSpace()}`;
            
            // Health with color coding
            const healthElement = document.getElementById('health');
            healthElement.textContent = `${gameState.health}%`;
            
            // Remove existing health classes
            healthElement.classList.remove('health-critical', 'health-low', 'health-good', 'health-excellent');
            document.querySelector('.stat-item:nth-child(6)').classList.remove('health-warning');
            
            // Add appropriate health class
            if (gameState.health <= 20) {
                healthElement.classList.add('health-critical');
                document.querySelector('.stat-item:nth-child(6)').classList.add('health-warning');
            } else if (gameState.health <= 40) {
                healthElement.classList.add('health-low');
            } else if (gameState.health <= 80) {
                healthElement.classList.add('health-good');
            } else {
                healthElement.classList.add('health-excellent');
            }
            
            document.getElementById('current-location').textContent = gameState.location;
            
            updateDrugList();
            updateInventory();
            updateItemsDisplay();
            
            // Check game over conditions
            if (gameState.day > gameState.maxDays) {
                endGame();
            }
            if (gameState.health <= 0) {
                showMessage("üíÄ You died from poor health! Game Over!");
                setTimeout(() => location.reload(), 3000);
            }
        }
        
        // Update items display
        function updateItemsDisplay() {
            const itemsGrid = document.getElementById('items-grid');
            itemsGrid.innerHTML = '';
            
            blackMarketItems.forEach(item => {
                const button = document.createElement('button');
                button.className = 'item-button';
                
                const itemState = gameState.items[item.id];
                let canBuy = true;
                let buttonText = '';
                
                if (item.consumable) {
                    const owned = itemState.owned || 0;
                    const maxStack = item.maxStack || 99;
                    canBuy = gameState.cash >= item.price && owned < maxStack;
                    
                    if (owned > 0) {
                        button.innerHTML = `<span class="item-owned">${owned}</span>`;
                    }
                } else {
                    canBuy = gameState.cash >= item.price && (!itemState.owned || itemState.broken);
                    
                    if (itemState.owned && itemState.broken) {
                        button.classList.add('item-broken');
                    } else if (itemState.owned) {
                        canBuy = false;
                        button.innerHTML = `<span class="item-owned">‚úì</span>`;
                    }
                }
                
                button.innerHTML += `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">$${item.price.toLocaleString()}</div>
                    <div class="item-effect">${item.effect}</div>
                `;
                
                button.disabled = !canBuy;
                button.onclick = () => buyItem(item.id);
                button.setAttribute('aria-label', `${item.name}: ${item.description}`);
                
                itemsGrid.appendChild(button);
            });
        }
        
        // Buy item function
        function buyItem(itemId) {
            const item = blackMarketItems.find(i => i.id === itemId);
            if (!item || gameState.cash < item.price) {
                showMessage("You can't afford that!");
                return;
            }
            
            if (item.consumable) {
                const currentOwned = gameState.items[itemId].owned || 0;
                const maxStack = item.maxStack || 99;
                
                if (currentOwned >= maxStack) {
                    showMessage(`You can't carry any more ${item.name}!`);
                    return;
                }
                
                gameState.cash -= item.price;
                gameState.items[itemId].owned = currentOwned + 1;
                showMessage(`Bought ${item.name}! Now have ${gameState.items[itemId].owned}.`);
            } else {
                if (gameState.items[itemId].owned && !gameState.items[itemId].broken) {
                    showMessage("You already have that item!");
                    return;
                }
                
                gameState.cash -= item.price;
                gameState.items[itemId].owned = true;
                gameState.items[itemId].broken = false;
                gameState.items[itemId].durability = 100;
                
                // Apply special effects
                if (itemId === 'coat' || itemId === 'duffelBag') {
                    gameState.maxSpace = getMaxSpace();
                }
                
                showMessage(`Bought ${item.name}! ${item.description}`);
            }
            
            updateDisplay();
        }
        
        // Use consumable item
        function useItem(itemId) {
            const item = blackMarketItems.find(i => i.id === itemId);
            if (!item || !item.consumable || gameState.items[itemId].owned <= 0) {
                return false;
            }
            
            gameState.items[itemId].owned--;
            
            switch(itemId) {
                case 'painkillers':
                    gameState.health = Math.min(100, gameState.health + 10);
                    showMessage("Used painkillers! +10 health");
                    break;
                case 'firstAid':
                    gameState.health = Math.min(100, gameState.health + 20);
                    showMessage("Used first aid kit! +20 health");
                    break;
            }
            
            updateDisplay();
            return true;
        }
        
        // Enhanced random events with health and item effects
        function randomEvent() {
            const riskMultiplier = getHealthRiskMultiplier();
            const baseEventChance = 0.3 * riskMultiplier;
            
            if (Math.random() > baseEventChance) return;
            
            const events = [
                () => {
                    // Police encounter with enhanced mechanics
                    if (getUsedSpace() > 30) {
                        let caught = true;
                        
                        // Fake ID protection
                        if (gameState.items.fakeId.owned && !gameState.items.fakeId.broken && Math.random() < 0.5) {
                            showMessage("Police stopped you but your fake ID worked!");
                            damageItem('fakeId', 15);
                            return;
                        }
                        
                        // Burner phone warning
                        if (gameState.items.phone.owned && !gameState.items.phone.broken && Math.random() < 0.25) {
                            showMessage("Your burner phone warned you about a police checkpoint! You avoided it.");
                            damageItem('phone', 10);
                            return;
                        }
                        
                        // Gun protection
                        if (gameState.items.gun.owned && !gameState.items.gun.broken && Math.random() < 0.5) {
                            showMessage("Police tried to arrest you but you scared them off with your gun!");
                            damageItem('gun', 25);
                            return;
                        }
                        
                        // Caught by police
                        const fine = Math.floor(gameState.cash * (0.2 + (1 - getHealthMultiplier()) * 0.3));
                        gameState.cash = Math.max(0, gameState.cash - fine);
                        
                        let healthLoss = Math.floor(Math.random() * 25) + 15;
                        
                        // Body armor protection
                        if (gameState.items.armor.owned && !gameState.items.armor.broken) {
                            healthLoss = Math.floor(healthLoss * 0.5);
                            damageItem('armor', 30);
                            showMessage(`Police beat you up but your armor helped! Lost $${fine.toLocaleString()} and ${healthLoss} health.`);
                        } else {
                            showMessage(`Police roughed you up badly! Lost $${fine.toLocaleString()} and ${healthLoss} health!`);
                        }
                        
                        gameState.health = Math.max(0, gameState.health - healthLoss);
                    }
                },
                () => {
                    // Enhanced mugging with item effects
                    let mugged = true;
                    
                    // Gun protection
                    if (gameState.items.gun.owned && !gameState.items.gun.broken && Math.random() < 0.7) {
                        showMessage("Muggers tried to rob you but ran when they saw your gun!");
                        damageItem('gun', 10);
                        return;
                    }
                    
                    const loss = Math.floor(gameState.cash * (0.15 + (1 - getHealthMultiplier()) * 0.1));
                    gameState.cash = Math.max(0, gameState.cash - loss);
                    
                    let healthLoss = Math.floor(Math.random() * 20) + 10;
                    
                    // Body armor protection
                    if (gameState.items.armor.owned && !gameState.items.armor.broken) {
                        healthLoss = Math.floor(healthLoss * 0.5);
                        damageItem('armor', 25);
                        showMessage(`Got mugged but your armor helped! Lost $${loss.toLocaleString()} and ${healthLoss} health.`);
                    } else {
                        showMessage(`Got mugged badly! Lost $${loss.toLocaleString()} and ${healthLoss} health!`);
                    }
                    
                    gameState.health = Math.max(0, gameState.health - healthLoss);
                },
                () => {
                    // Find drugs
                    const drug = drugs[Math.floor(Math.random() * drugs.length)];
                    const amount = Math.floor(Math.random() * 8) + 1;
                    const spaceLeft = getMaxSpace() - getUsedSpace();
                    if (spaceLeft >= amount) {
                        gameState.inventory[drug.name] = (gameState.inventory[drug.name] || 0) + amount;
                        showMessage(`Found ${amount} units of ${drug.name} hidden in an alley!`);
                    }
                },
                () => {
                    // Find cash
                    const found = Math.floor(Math.random() * 1000) + 100;
                    gameState.cash += found;
                    showMessage(`Found $${found.toLocaleString()} in a wallet!`);
                },
                () => {
                    // Health event - overdose customer
                    if (Math.random() < 0.15) {
                        const healthLoss = Math.floor(Math.random() * 15) + 5;
                        gameState.health = Math.max(0, gameState.health - healthLoss);
                        showMessage(`A customer overdosed near you. The stress made you feel sick! -${healthLoss} health.`);
                    }
                }
            ];
            
            events[Math.floor(Math.random() * events.length)]();
        }
        
        // Travel with enhanced mechanics
        function travel(destination) {
            closeTravelModal();
            gameState.location = destination;
            gameState.day++;
            
            // Daily health decay
            applyDailyHealthDecay();
            
            // Interest on debt
            gameState.debt = Math.floor(gameState.debt * 1.1);
            
            // Update prices for new location
            updatePrices();
            
            // Random events with health consideration
            randomEvent();
            
            showMessage(`Traveled to ${destination}. Day ${gameState.day}. Health: ${gameState.health}%`);
            updateDisplay();
        }
        
        // Enhanced hospital with higher prices
        function visitHospital() {
            if (gameState.health >= 100) {
                showMessage("You're already at full health!");
                return;
            }
            
            // More expensive hospital - $200 per health point
            const healCost = (100 - gameState.health) * 200;
            
            const options = [];
            
            // Full heal option
            if (gameState.cash >= healCost) {
                options.push(`Full heal to 100% for $${healCost.toLocaleString()}`);
            }
            
            // Partial heal options
            const partialHeal50Cost = Math.min(50, 100 - gameState.health) * 200;
            const partialHeal25Cost = Math.min(25, 100 - gameState.health) * 200;
            
            if (gameState.cash >= partialHeal50Cost && partialHeal50Cost > 0) {
                options.push(`Heal 50 points for $${partialHeal50Cost.toLocaleString()}`);
            }
            if (gameState.cash >= partialHeal25Cost && partialHeal25Cost > 0) {
                options.push(`Heal 25 points for $${partialHeal25Cost.toLocaleString()}`);
            }
            
            // Use items option
            if (gameState.items.firstAid.owned > 0) {
                options.push("Use First Aid Kit (+20 health) - FREE");
            }
            if (gameState.items.painkillers.owned > 0) {
                options.push("Use Painkillers (+10 health) - FREE");
            }
            
            if (options.length === 0) {
                showMessage("You can't afford any treatment! Buy some medical supplies.");
                return;
            }
            
            // Simple choice for demo - in full version, would show proper menu
            if (gameState.items.firstAid.owned > 0) {
                useItem('firstAid');
            } else if (gameState.items.painkillers.owned > 0) {
                useItem('painkillers');
            } else if (confirm(`Hospital Treatment:\nFull heal costs $${healCost.toLocaleString()}\nProceed?`)) {
                if (gameState.cash >= healCost) {
                    gameState.cash -= healCost;
                    gameState.health = 100;
                    showMessage(`Hospital healed you to full health for $${healCost.toLocaleString()}`);
                    updateDisplay();
                } else {
                    showMessage("You can't afford treatment!");
                }
            }
        }
        
        // Update remaining functions (simplified for space)...
        function updateDrugList() {
            const drugList = document.getElementById('drug-list');
            drugList.innerHTML = '';
            
            drugs.forEach((drug, index) => {
                const div = document.createElement('div');
                div.className = 'drug-item';
                div.setAttribute('role', 'listitem');
                div.setAttribute('tabindex', '0');
                
                const owned = gameState.inventory[drug.name] || 0;
                const price = gameState.prices[drug.name];
                
                div.innerHTML = `
                    <span class="drug-name">${drug.name}</span>
                    <span class="drug-price">$${price.toLocaleString()}</span>
                    <span class="drug-owned">Own: ${owned}</span>
                    <div class="drug-buttons">
                        <button onclick="buyDrug('${drug.name}')" aria-label="Buy ${drug.name}">Buy</button>
                        <button onclick="sellDrug('${drug.name}')" ${owned === 0 ? 'disabled' : ''} aria-label="Sell ${drug.name}">Sell</button>
                    </div>
                `;
                
                drugList.appendChild(div);
            });
        }
        
        function updateInventory() {
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            
            let hasItems = false;
            for (const [drug, qty] of Object.entries(gameState.inventory)) {
                if (qty > 0) {
                    hasItems = true;
                    const div = document.createElement('div');
                    div.className = 'inventory-item';
                    div.innerHTML = `
                        <span>${drug}:</span>
                        <span>${qty} units</span>
                    `;
                    inventoryList.appendChild(div);
                }
            }
            
            if (!hasItems) {
                inventoryList.innerHTML = '<div style="text-align: center; opacity: 0.7;">Empty - buy some product!</div>';
            }
        }
        
        // Buy/Sell drug functions with health effects
        function buyDrug(drugName) {
            const basePrice = gameState.prices[drugName];
            const healthMultiplier = getHealthMultiplier();
            const price = Math.floor(basePrice * (2 - healthMultiplier)); // Worse health = higher prices
            
            const maxCanBuy = Math.floor(gameState.cash / price);
            const spaceLeft = getMaxSpace() - getUsedSpace();
            const maxAfford = Math.min(maxCanBuy, spaceLeft);
            
            if (maxAfford === 0) {
                showMessage(spaceLeft === 0 ? "No space left!" : "You can't afford any!");
                return;
            }
            
            showModal(
                `Buy ${drugName}`,
                `Price: $${price.toLocaleString()} each (health affects prices)<br>You can afford: ${maxAfford} units`,
                (amount) => {
                    amount = parseInt(amount);
                    if (amount > 0 && amount <= maxAfford) {
                        const cost = amount * price;
                        gameState.cash -= cost;
                        gameState.inventory[drugName] = (gameState.inventory[drugName] || 0) + amount;
                        showMessage(`Bought ${amount} ${drugName} for $${cost.toLocaleString()}`);
                        updateDisplay();
                    }
                }
            );
        }
        
        function sellDrug(drugName) {
            const owned = gameState.inventory[drugName] || 0;
            if (owned === 0) return;
            
            const basePrice = gameState.prices[drugName];
            const healthMultiplier = getHealthMultiplier();
            const price = Math.floor(basePrice * healthMultiplier); // Poor health = lower selling prices
            
            showModal(
                `Sell ${drugName}`,
                `Price: $${price.toLocaleString()} each (health affects prices)<br>You have: ${owned} units`,
                (amount) => {
                    amount = parseInt(amount);
                    if (amount > 0 && amount <= owned) {
                        const revenue = amount * price;
                        gameState.cash += revenue;
                        gameState.inventory[drugName] -= amount;
                        if (gameState.inventory[drugName] === 0) {
                            delete gameState.inventory[drugName];
                        }
                        showMessage(`Sold ${amount} ${drugName} for $${revenue.toLocaleString()}`);
                        updateDisplay();
                    }
                }
            );
        }
        
        // Modal and UI functions remain largely the same...
        function showModal(title, text, onConfirm) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').innerHTML = text;
            const input = document.getElementById('modal-input');
            input.value = '';
            
            document.getElementById('modal-confirm').onclick = () => {
                onConfirm(input.value);
                closeModal();
            };
            
            modal.style.display = 'flex';
            setTimeout(() => input.focus(), 100);
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        function showTravelMenu() {
            const modal = document.getElementById('travel-modal');
            const options = document.getElementById('travel-options');
            options.innerHTML = '';
            
            locations.forEach((loc, index) => {
                if (loc !== gameState.location) {
                    const btn = document.createElement('button');
                    btn.textContent = `${index + 1}. ${loc}`;
                    btn.style.width = '100%';
                    btn.style.marginBottom = '10px';
                    btn.onclick = () => travel(loc);
                    options.appendChild(btn);
                }
            });
            
            modal.style.display = 'flex';
        }
        
        function closeTravelModal() {
            document.getElementById('travel-modal').style.display = 'none';
        }
        
        function visitLoanShark() {
            showModal(
                'Loan Shark',
                `Current debt: $${gameState.debt.toLocaleString()}<br>Pay how much?`,
                (amount) => {
                    amount = parseInt(amount);
                    if (amount > 0 && amount <= gameState.cash && amount <= gameState.debt) {
                        gameState.cash -= amount;
                        gameState.debt -= amount;
                        showMessage(`Paid $${amount.toLocaleString()} to the loan shark`);
                        updateDisplay();
                    }
                }
            );
        }
        
        function visitBank() {
            const action = gameState.bank > 0 ? 
                confirm(`Bank balance: $${gameState.bank.toLocaleString()}\n\nDeposit (OK) or Withdraw (Cancel)?`) :
                true;
            
            if (action) {
                showModal(
                    'Bank Deposit',
                    `Cash: $${gameState.cash.toLocaleString()}<br>Deposit how much?`,
                    (amount) => {
                        amount = parseInt(amount);
                        if (amount > 0 && amount <= gameState.cash) {
                            gameState.cash -= amount;
                            gameState.bank += amount;
                            showMessage(`Deposited $${amount.toLocaleString()}`);
                            updateDisplay();
                        }
                    }
                );
            } else {
                showModal(
                    'Bank Withdrawal',
                    `Bank balance: $${gameState.bank.toLocaleString()}<br>Withdraw how much?`,
                    (amount) => {
                        amount = parseInt(amount);
                        if (amount > 0 && amount <= gameState.bank) {
                            gameState.bank -= amount;
                            gameState.cash += amount;
                            showMessage(`Withdrew $${amount.toLocaleString()}`);
                            updateDisplay();
                        }
                    }
                );
            }
        }
        
        function showMessage(text) {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = text;
            messageEl.classList.add('flash');
            setTimeout(() => messageEl.classList.remove('flash'), 500);
        }
        
        function showInfo() {
            document.getElementById('info-modal').style.display = 'flex';
        }
        
        function closeInfoModal() {
            document.getElementById('info-modal').style.display = 'none';
        }
        
        function endGame() {
            const netWorth = gameState.cash + gameState.bank - gameState.debt;
            let rating = '';
            
            if (netWorth < 0) rating = 'Street Junkie';
            else if (netWorth < 10000) rating = 'Small Time Dealer';
            else if (netWorth < 50000) rating = 'Neighborhood Supplier';
            else if (netWorth < 100000) rating = 'Drug Lord';
            else if (netWorth < 500000) rating = 'Kingpin';
            else rating = 'Pablo Escobar';
            
            alert(`GAME OVER!\n\nNet Worth: $${netWorth.toLocaleString()}\nFinal Health: ${gameState.health}%\nRating: ${rating}\n\nPlay again?`);
            location.reload();
        }
        
        // Initialize game
        initGame();
    </script>
</body>
</html>